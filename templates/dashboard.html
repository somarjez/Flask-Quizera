{% extends "base.html" %}
{% block title %}Dashboard - Quizera{% endblock %}

{% block extra_head %}
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    .gradient-text {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .card-hover {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    
    /* Formal Landscape Certificate Styles */
    .certificate-container {
        width: 297mm;
        height: 210mm;
        background: linear-gradient(135deg, #ffffff 0%, #fefefe 50%, #ffffff 100%);
        position: relative;
        overflow: hidden;
        box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        border: 1px solid #e5e7eb;
    }
    
    .certificate-border {
        border: 12px solid #1f2937;
        border-radius: 8px;
        margin: 15px;
        height: calc(100% - 30px);
        position: relative;
        background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
    }
    
    .certificate-inner-border {
        border: 3px solid #d4af37;
        border-radius: 4px;
        margin: 12px;
        height: calc(100% - 24px);
        position: relative;
        background: #ffffff;
    }
    
    .certificate-header {
        text-align: center;
        padding: 25px 0 15px 0;
        border-bottom: 2px solid #d4af37;
        margin: 0 50px;
    }
    
    .certificate-logo {
        font-size: 36px;
        font-weight: 900;
        color: #1f2937;
        margin-bottom: 8px;
        letter-spacing: 4px;
        font-family: 'Times New Roman', serif;
    }
    
    .certificate-subtitle {
        color: #4b5563;
        font-size: 12px;
        font-weight: 600;
        letter-spacing: 3px;
        text-transform: uppercase;
        font-family: 'Arial', sans-serif;
    }
    
    .certificate-institution {
        color: #6b7280;
        font-size: 10px;
        font-weight: 500;
        letter-spacing: 2px;
        text-transform: uppercase;
        margin-top: 5px;
        font-family: 'Arial', sans-serif;
    }
    
    .certificate-title {
        font-size: 28px;
        font-weight: bold;
        color: #1f2937;
        margin: 25px 0 20px 0;
        letter-spacing: 2px;
        text-transform: uppercase;
        font-family: 'Times New Roman', serif;
    }
    
    .certificate-body {
        text-align: center;
        padding: 0 80px;
        line-height: 1.6;
        font-family: 'Times New Roman', serif;
    }
    
    .certificate-text {
        font-size: 14px;
        color: #374151;
        margin-bottom: 15px;
        font-weight: 400;
    }
    
    .certificate-name {
        font-size: 32px;
        font-weight: bold;
        color: #1f2937;
        margin: 20px 0;
        border-bottom: 2px solid #d4af37;
        display: inline-block;
        padding-bottom: 5px;
        font-family: 'Times New Roman', serif;
    }
    
    .certificate-subject {
        font-size: 20px;
        font-weight: bold;
        color: #1f2937;
        margin: 20px 0;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-family: 'Times New Roman', serif;
    }
    
    .certificate-achievement {
        font-size: 13px;
        color: #374151;
        margin: 15px 0;
        font-style: italic;
    }
    
    .certificate-footer {
        position: absolute;
        bottom: 30px;
        left: 0;
        right: 0;
        padding: 0 50px;
    }
    
    .certificate-signatures {
        display: flex;
        justify-content: space-between;
        align-items: end;
        margin-top: 40px;
    }
    
    .signature-section {
        text-align: center;
        position: relative;
        width: 180px;
    }
    
    .signature-line {
        width: 180px;
        border-top: 1px solid #374151;
        margin-bottom: 8px;
    }
    
    .signature-label {
        font-size: 11px;
        color: #4b5563;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-family: 'Arial', sans-serif;
    }
    
    .signature-title {
        font-size: 10px;
        color: #6b7280;
        margin-top: 3px;
        font-family: 'Arial', sans-serif;
    }
    
    .certificate-seal {
        position: absolute;
        top: 40%;
        right: 50px;
        transform: translateY(-50%);
        width: 100px;
        height: 100px;
        border: 3px solid #d4af37;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle, #fef3c7 0%, #f59e0b 100%);
        box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
    }
    
    .seal-text {
        font-size: 8px;
        font-weight: bold;
        color: #92400e;
        text-align: center;
        line-height: 1.1;
        font-family: 'Arial', sans-serif;
    }
    
    .certificate-date-section {
        position: absolute;
        bottom: 30px;
        right: 50px;
        text-align: center;
        font-family: 'Times New Roman', serif;
    }
    
    .certificate-date {
        font-size: 11px;
        color: #374151;
        font-weight: 500;
    }
    
    .certificate-decorations {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        overflow: hidden;
    }
    
    .decoration-corner {
        position: absolute;
        width: 60px;
        height: 60px;
        background: linear-gradient(45deg, rgba(212, 175, 55, 0.1) 0%, transparent 70%);
    }
    
    .decoration-corner.top-left {
        top: 0;
        left: 0;
        border-radius: 0 0 60px 0;
    }
    
    .decoration-corner.top-right {
        top: 0;
        right: 0;
        border-radius: 0 0 0 60px;
    }
    
    .decoration-corner.bottom-left {
        bottom: 0;
        left: 0;
        border-radius: 0 60px 0 0;
    }
    
    .decoration-corner.bottom-right {
        bottom: 0;
        right: 0;
        border-radius: 60px 0 0 0;
    }
    
    @media print {
        .certificate-container {
            width: 297mm;
            height: 210mm;
            margin: 0;
            box-shadow: none;
        }
    }
</style>
<!-- Add jsPDF library for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
{% endblock %}

{% block content %}
    <!-- Main Dashboard Content -->
    <div class="container mx-auto px-4 py-8">
        {% if role == 'teacher' %}
            <!-- Teacher Dashboard -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-800 gradient-text mb-2">Teacher Dashboard</h1>
                <p class="text-gray-600">Manage your subjects and quizzes</p>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Manage Subjects -->
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800">
                            <i class="fas fa-book text-blue-600 mr-2"></i>My Subjects
                        </h2>
                        <a href="{{ url_for('create_subject') }}" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 btn-hover transition-all">
                            <i class="fas fa-plus mr-1"></i>Add Subject
                        </a>
                    </div>
                    
                    <!-- Subject Search -->
                    <div class="mb-4">
                        <div class="relative">
                            <input type="text" id="subject-search" placeholder="Search subjects..." 
                                   class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4 max-h-96 overflow-y-auto" id="subjects-container">
                        {% if subjects %}
                            {% for subject in subjects %}
                                <div class="border border-gray-200 rounded-lg p-4 subject-card" data-subject-name="{{ subject.name|lower }}" data-subject-description="{{ subject.description|lower }}">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <h3 class="font-semibold text-lg text-white">{{ subject.name }}</h3>
                                            <p class="text-gray-100 text-sm mt-1">{{ subject.description }}</p>
                                            <p class="text-gray-200 text-xs mt-2">
                                                <i class="fas fa-list-ul mr-1"></i>{{ subject.topic_count|default(0) }} Topics
                                            </p>
                                        </div>
                                    </div>
                                    <div class="mt-4 flex space-x-2">
                                        <a href="{{ url_for('view_subject', subject_id=subject.id) }}" class="bg-white text-purple-600 px-3 py-1 rounded text-sm hover:bg-gray-100 transition-colors">
                                            <i class="fas fa-eye mr-1"></i>View
                                        </a>
                                        <button class="subject-edit-btn bg-yellow-400 text-purple-800 px-3 py-1 rounded text-sm hover:bg-yellow-300 transition-colors"
                                                data-subject-id="{{ subject.id }}"
                                                data-subject-name="{{ subject.name }}"
                                                data-subject-description="{{ subject.description }}">
                                            <i class="fas fa-edit mr-1"></i>Edit
                                        </button>
                                        <button class="subject-delete-btn bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition-colors"
                                                data-subject-id="{{ subject.id }}"
                                                data-subject-name="{{ subject.name }}">
                                            <i class="fas fa-trash mr-1"></i>Delete
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-8">
                                <i class="fas fa-book text-gray-400 text-4xl mb-4"></i>
                                <p class="text-gray-500">No subjects created yet.</p>
                                <p class="text-gray-400 text-sm">Create your first subject to get started!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- My Quizzes -->
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800">
                            <i class="fas fa-question-circle text-purple-600 mr-2"></i>My Quizzes
                        </h2>
                        <a href="{{ url_for('create_quiz') }}" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 btn-hover transition-all">
                            <i class="fas fa-plus mr-1"></i>Create Quiz
                        </a>
                    </div>
                    
                    <!-- Quiz Search -->
                    <div class="mb-4">
                        <div class="relative">
                            <input type="text" id="quiz-search" placeholder="Search quizzes..." 
                                   class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Subject Filter for Quizzes -->
                    <div class="mb-4">
                        <select id="subject-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="">All Subjects</option>
                            {% for subject in subjects %}
                                <option value="{{ subject.name|lower }}">{{ subject.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="space-y-4 max-h-96 overflow-y-auto" id="quizzes-container">
                        {% if quizzes %}
                            {% set quizzes_by_subject = {} %}
                            {% for quiz in quizzes %}
                                {% set subject_name = quiz.subject_name %}
                                {% if subject_name not in quizzes_by_subject %}
                                    {% set _ = quizzes_by_subject.update({subject_name: []}) %}
                                {% endif %}
                                {% set _ = quizzes_by_subject[subject_name].append(quiz) %}
                            {% endfor %}
                            
                            {% for subject_name, subject_quizzes in quizzes_by_subject.items() %}
                                <div class="subject-group mb-6" data-subject="{{ subject_name|lower }}">
                                    <h4 class="text-lg font-semibold text-gray-700 mb-3 border-b border-gray-200 pb-2">
                                        <i class="fas fa-book text-blue-500 mr-2"></i>{{ subject_name }}
                                        <span class="text-sm text-gray-500 ml-2">({{ subject_quizzes|length }} quiz{{ 'es' if subject_quizzes|length != 1 else '' }})</span>
                                    </h4>
                                    <div class="space-y-3">
                                        {% for quiz in subject_quizzes %}
                                            <div class="border border-gray-200 rounded-lg p-4 quiz-card ml-4" 
                                                 data-quiz-title="{{ quiz.title|lower }}" 
                                                 data-subject="{{ subject_name|lower }}">
                                                <div class="flex justify-between items-start">
                                                    <div class="flex-1">
                                                        <h3 class="font-semibold text-lg text-white">{{ quiz.title }}</h3>
                                                        <div class="flex items-center space-x-4 mt-2 text-xs text-gray-200">
                                                            <span><i class="fas fa-question mr-1"></i>{{ quiz.question_count|default(0) }} Questions</span>
                                                            <span><i class="fas fa-clock mr-1"></i>{{ quiz.time_limit|default(30) }} min</span>
                                                            {% if quiz.is_published %}
                                                                <span class="bg-green-500 px-2 py-1 rounded"><i class="fas fa-check mr-1"></i>Published</span>
                                                            {% else %}
                                                                <span class="bg-orange-500 px-2 py-1 rounded"><i class="fas fa-draft2digital mr-1"></i>Draft</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="mt-4 flex space-x-2">
                                                    <a href="{{ url_for('manage_quiz', quiz_id=quiz.id) }}" class="bg-white text-purple-600 px-3 py-1 rounded text-sm hover:bg-gray-100 transition-colors">
                                                        <i class="fas fa-cog mr-1"></i>Manage
                                                    </a>
                                                    <button class="quiz-preview-btn bg-blue-400 text-white px-3 py-1 rounded text-sm hover:bg-blue-500 transition-colors"
                                                            data-quiz-id="{{ quiz.id }}">
                                                        <i class="fas fa-eye mr-1"></i>Preview
                                                    </button>
                                                    <button class="quiz-delete-btn bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition-colors"
                                                            data-quiz-id="{{ quiz.id }}"
                                                            data-quiz-title="{{ quiz.title }}">
                                                        <i class="fas fa-trash mr-1"></i>Delete
                                                    </button>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-8">
                                <i class="fas fa-question-circle text-gray-400 text-4xl mb-4"></i>
                                <p class="text-gray-500">No quizzes created yet.</p>
                                <p class="text-gray-400 text-sm">Create your first quiz to get started!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% elif role == 'student' %}
            <!-- Student Dashboard -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-800 gradient-text mb-2">Student Dashboard</h1>
                <p class="text-gray-600">Explore your enrolled subjects and take quizzes</p>
            </div>
            
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Enrolled Subjects with Progress -->
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <div class="flex items-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800">
                            <i class="fas fa-bookmark text-green-600 mr-2"></i>My Enrolled Subjects
                        </h2>
                    </div>
                    
                    <!-- Subject Search for Students -->
                    <div class="mb-4">
                        <div class="relative">
                            <input type="text" id="enrolled-subject-search" placeholder="Search enrolled subjects..." 
                                   class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4 max-h-96 overflow-y-auto" id="enrolled-subjects-container">
                        {% if enrolled_subjects %}
                            {% for subject in enrolled_subjects %}
                                {% set quiz_progress = subject_progress.get(subject.id, {}) %}
                                {% set total_quizzes = quiz_progress.get('total_quizzes', 0) %}
                                {% set passed_quizzes = quiz_progress.get('passed_quizzes', 0) %}
                                {% set completion_percentage = (passed_quizzes / total_quizzes * 100) if total_quizzes > 0 else 0 %}
                                {% set all_passed = passed_quizzes == total_quizzes and total_quizzes > 0 %}
                                
                                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors subject-card" 
                                     data-subject-name="{{ subject.name|lower }}" 
                                     data-subject-description="{{ subject.description|lower }}"
                                     data-teacher-name="{{ subject.teacher_name|lower }}">
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="flex-1">
                                            <h3 class="font-semibold text-lg text-white flex items-center">
                                                {{ subject.name }}
                                                {% if all_passed %}
                                                    <span class="ml-2 bg-green-500 text-white text-xs px-2 py-1 rounded-full">
                                                        <i class="fas fa-trophy mr-1"></i>Complete
                                                    </span>
                                                {% endif %}
                                            </h3>
                                            <p class="text-gray-100 text-sm mt-1">{{ subject.description }}</p>
                                            <p class="text-gray-200 text-xs mt-2">
                                                <i class="fas fa-user mr-1"></i>{{ subject.teacher_name }}
                                                <span class="ml-4"><i class="fas fa-list-ul mr-1"></i>{{ subject.topic_count or 0 }} Topics</span>
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <!-- Progress Bar -->
                                    {% if total_quizzes > 0 %}
                                        <div class="mb-3">
                                            <div class="flex justify-between items-center mb-1">
                                                <span class="text-xs text-gray-500">Quiz Progress</span>
                                                <span class="text-xs text-gray-500">{{ passed_quizzes }}/{{ total_quizzes }} passed</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-2">
                                                <div class="bg-gradient-to-r from-green-400 to-green-600 h-2 rounded-full transition-all duration-300" 
                                                     style="width: {{ completion_percentage }}%"></div>
                                            </div>
                                            <p class="text-xs text-gray-500 mt-1">{{ "%.0f"|format(completion_percentage) }}% complete</p>
                                        </div>
                                    {% endif %}
                                    
                                    <div class="mt-3 flex space-x-2">
                                        <a href="{{ url_for('view_subject', subject_id=subject.id) }}" class="bg-white text-purple-600 px-3 py-1 rounded text-sm hover:bg-gray-100 transition-colors">
                                            <i class="fas fa-book-open mr-1"></i>Study
                                        </a>
                                        {% if all_passed %}
                                            <button class="download-certificate-btn bg-gold-500 text-white px-3 py-1 rounded text-sm hover:bg-gold-600 transition-colors"
                                                    data-subject-id="{{ subject.id }}"
                                                    data-subject-name="{{ subject.name }}"
                                                    style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                                <i class="fas fa-download mr-1"></i>Certificate
                                            </button>
                                        {% endif %}
                                        <button class="bg-red-100 text-red-600 px-3 py-1 rounded text-sm hover:bg-red-200 transition-colors"
                                                onclick="unenrollFromSubject('{{ subject.id }}', '{{ subject.name }}')">
                                            <i class="fas fa-times mr-1"></i>Unenroll
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-8">
                                <i class="fas fa-bookmark text-gray-400 text-4xl mb-4"></i>
                                <p class="text-gray-500">No enrolled subjects yet.</p>
                                <p class="text-gray-400 text-sm mb-4">Discover and enroll in subjects to get started!</p>
                                <div class="text-sm text-gray-500">
                                    <p class="mb-2">You can find subjects by:</p>
                                    <ul class="text-left inline-block">
                                        <li>• Using the "Subjects" section in the navigation menu</li>
                                        <li>• Asking your teacher for subject enrollment codes</li>
                                        <li>• Browsing the available subjects catalog</li>
                                    </ul>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Available Quizzes with Status -->
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-800">
                        <i class="fas fa-tasks text-green-600 mr-2"></i>Available Quizzes
                    </h2>
                    
                    <!-- Quiz Search for Students -->
                    <div class="mb-4">
                        <div class="relative">
                            <input type="text" id="student-quiz-search" placeholder="Search quizzes..." 
                                   class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Subject Filter for Student Quizzes -->
                    <div class="mb-4">
                        <select id="student-subject-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <option value="">All Subjects</option>
                            {% for subject in enrolled_subjects %}
                                <option value="{{ subject.name|lower }}">{{ subject.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="space-y-4 max-h-96 overflow-y-auto" id="student-quizzes-container">
                        {% if quizzes %}
                            {% set student_quizzes_by_subject = {} %}
                            {% for quiz in quizzes %}
                                {% if quiz.is_published %}
                                    {% set subject_name = quiz.subject_name %}
                                    {% if subject_name not in student_quizzes_by_subject %}
                                        {% set _ = student_quizzes_by_subject.update({subject_name: []}) %}
                                    {% endif %}
                                    {% set _ = student_quizzes_by_subject[subject_name].append(quiz) %}
                                {% endif %}
                            {% endfor %}
                            
                            {% for subject_name, subject_quizzes in student_quizzes_by_subject.items() %}
                                <div class="subject-group mb-6" data-subject="{{ subject_name|lower }}">
                                    <h4 class="text-lg font-semibold text-gray-700 mb-3 border-b border-gray-200 pb-2">
                                        <i class="fas fa-book text-green-500 mr-2"></i>{{ subject_name }}
                                        <span class="text-sm text-gray-500 ml-2">({{ subject_quizzes|length }} quiz{{ 'es' if subject_quizzes|length != 1 else '' }})</span>
                                    </h4>
                                    <div class="space-y-3">
                                        {% for quiz in subject_quizzes %}
                                            {% set quiz_status = quiz_progress_data.get(quiz.id, {}) %}
                                            {% set best_score = quiz_status.get('best_score', 0) %}
                                            {% set is_passed = quiz_status.get('is_passed', False) %}
                                            {% set attempts_count = quiz_status.get('attempts_count', 0) %}
                                            
                                            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors quiz-card ml-4" 
                                                 data-quiz-title="{{ quiz.title|lower }}" 
                                                 data-subject="{{ subject_name|lower }}">
                                                <div class="flex justify-between items-start mb-3">
                                                    <div class="flex-1">
                                                        <h3 class="font-semibold text-lg text-white flex items-center">
                                                            {{ quiz.title }}
                                                            {% if is_passed %}
                                                                <span class="ml-2 bg-green-500 text-white text-xs px-2 py-1 rounded-full">
                                                                    <i class="fas fa-check mr-1"></i>Passed
                                                                </span>
                                                            {% elif attempts_count > 0 %}
                                                                <span class="ml-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full">
                                                                    <i class="fas fa-redo mr-1"></i>Retake
                                                                </span>
                                                            {% endif %}
                                                        </h3>
                                                        <div class="flex items-center space-x-4 mt-2 text-xs text-gray-200">
                                                            <span><i class="fas fa-question mr-1"></i>{{ quiz.question_count|default(0) }} Questions</span>
                                                            <span><i class="fas fa-clock mr-1"></i>{{ quiz.time_limit|default(30) }} minutes</span>
                                                            {% if attempts_count > 0 %}
                                                                <span><i class="fas fa-star mr-1"></i>Best: {{ "%.0f"|format(best_score) }}%</span>
                                                                <span><i class="fas fa-list-ol mr-1"></i>{{ attempts_count }} attempts</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="mt-3 flex space-x-2">
                                                    <button class="quiz-take-btn bg-white text-purple-600 px-3 py-1 rounded text-sm hover:bg-gray-100 transition-colors"
                                                            data-quiz-id="{{ quiz.id }}">
                                                        <i class="fas fa-play mr-1"></i>
                                                        {% if attempts_count > 0 %}Retake{% else %}Take{% endif %} Quiz
                                                    </button>
                                                    {% if attempts_count > 0 %}
                                                        <button class="quiz-results-btn bg-yellow-400 text-purple-800 px-3 py-1 rounded text-sm hover:bg-yellow-300 transition-colors"
                                                                data-quiz-id="{{ quiz.id }}">
                                                            <i class="fas fa-chart-bar mr-1"></i>View Results
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-8">
                                <i class="fas fa-tasks text-gray-400 text-4xl mb-4"></i>
                                <p class="text-gray-500">No quizzes available yet.</p>
                                <p class="text-gray-400 text-sm">Enroll in subjects to access their quizzes!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
    
    <!-- Formal Landscape Certificate Modal -->
    <div id="certificateModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-5 mx-auto p-5 border w-11/12 max-w-6xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Certificate of Completion</h3>
                    <button onclick="closeCertificateModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <!-- Formal Landscape Certificate Preview -->
                <div id="certificatePreview" class="certificate-container mx-auto scale-50 origin-top" style="transform-origin: top center;">
                    <div class="certificate-border">
                        <div class="certificate-inner-border">
                            <!-- Decorative corners -->
                            <div class="certificate-decorations">
                                <div class="decoration-corner top-left"></div>
                                <div class="decoration-corner top-right"></div>
                                <div class="decoration-corner bottom-left"></div>
                                <div class="decoration-corner bottom-right"></div>
                            </div>
                            
                            <!-- Certificate Header -->
                            <div class="certificate-header">
                                <div class="certificate-logo">QUIZERA</div>
                                <div class="certificate-subtitle">Professional E-Learning Platform</div>
                                <div class="certificate-institution">Computer Science Education Institute</div>
                            </div>
                            
                            <!-- Certificate Body -->
                            <div class="certificate-body">
                                <h1 class="certificate-title">Certificate of Completion</h1>
                                
                                <p class="certificate-text">This is to certify that</p>
                                
                                <div class="certificate-name" id="studentName">{{ username }}</div>
                                
                                <p class="certificate-text">has successfully completed the comprehensive course requirements and demonstrated 
                                    proficiency in all assessments for the subject</p>
                                
                                <div class="certificate-subject" id="subjectName">Subject Name</div>
                                
                                <p class="certificate-achievement">
                                    This achievement represents dedication to academic excellence and mastery of the subject matter 
                                    as validated through rigorous assessment and evaluation.
                                </p>
                                
                                <div style="margin-top: 25px;">
                                    <p class="certificate-text" style="font-size: 12px; color: #6b7280;">
                                        Conferred on this <span id="completionDate"></span>
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Certificate Footer with Signatures -->
                            <div class="certificate-footer">
                                <div class="certificate-signatures">
                                    <div class="signature-section">
                                        <div class="signature-line"></div>
                                        <div class="signature-label">Student</div>
                                        <div class="signature-title">Recipient</div>
                                    </div>
                                    
                                    <div class="signature-section">
                                        <div class="signature-line"></div>
                                        <div class="signature-label">Dr. Academic Director</div>
                                        <div class="signature-title">QUIZERA Institute</div>
                                    </div>
                                    
                                    <div class="signature-section">
                                        <div class="signature-line"></div>
                                        <div class="signature-label">Registrar</div>
                                        <div class="signature-title">Academic Registry</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Official Seal -->
                            <div class="certificate-seal">
                                <div class="seal-text">
                                    <div style="font-size: 10px; font-weight: bold;">OFFICIAL</div>
                                    <div style="font-size: 8px;">SEAL</div>
                                    <div style="font-size: 6px; margin-top: 3px;">QUIZERA</div>
                                    <div style="font-size: 5px;">INSTITUTE</div>
                                </div>
                            </div>
                            
                            <!-- Date Section -->
                            <div class="certificate-date-section">
                                <div class="certificate-date">
                                    Certificate ID: QZ-<span id="certificateId"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-center space-x-4 mt-6">
                    <button onclick="downloadCertificateAsPDF()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-download mr-2"></i>Download PDF
                    </button>
                    <button onclick="printCertificate()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors">
                        <i class="fas fa-print mr-2"></i>Print
                    </button>
                    <button onclick="closeCertificateModal()" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors">
                        <i class="fas fa-times mr-2"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Search functionality
        function setupSearch(searchInputId, containerId, itemSelector, searchFields) {
            const searchInput = document.getElementById(searchInputId);
            const container = document.getElementById(containerId);
            
            if (searchInput && container) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const items = container.querySelectorAll(itemSelector);
                    
                    items.forEach(item => {
                        let shouldShow = false;
                        
                        searchFields.forEach(field => {
                            const fieldValue = item.dataset[field] || '';
                            if (fieldValue.includes(searchTerm)) {
                                shouldShow = true;
                            }
                        });
                        
                        if (shouldShow || searchTerm === '') {
                            item.style.display = 'block';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                    
                    // For grouped quizzes, hide empty subject groups
                    if (containerId.includes('quiz')) {
                        const subjectGroups = container.querySelectorAll('.subject-group');
                        subjectGroups.forEach(group => {
                            const visibleQuizzes = group.querySelectorAll('.quiz-card:not([style*="display: none"])');
                            if (visibleQuizzes.length === 0 && searchTerm !== '') {
                                group.style.display = 'none';
                            } else {
                                group.style.display = 'block';
                            }
                        });
                    }
                });
            }
        }
        
        // Subject filter functionality
        function setupSubjectFilter(filterId, containerId) {
            const filter = document.getElementById(filterId);
            const container = document.getElementById(containerId);
            
            if (filter && container) {
                filter.addEventListener('change', function() {
                    const selectedSubject = this.value.toLowerCase();
                    const subjectGroups = container.querySelectorAll('.subject-group');
                    
                    subjectGroups.forEach(group => {
                        if (selectedSubject === '' || group.dataset.subject === selectedSubject) {
                            group.style.display = 'block';
                        } else {
                            group.style.display = 'none';
                        }
                    });
                });
            }
        }
        
        // Generate unique certificate ID
        function generateCertificateId() {
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substr(2, 5);
            return (timestamp + random).toUpperCase();
        }
        
        // Enhanced Certificate functions
        function generateCertificate(subjectId, subjectName) {
            const currentDate = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            const certificateId = generateCertificateId();
            
            // Update certificate content
            document.getElementById('subjectName').textContent = subjectName;
            document.getElementById('completionDate').textContent = currentDate;
            document.getElementById('certificateId').textContent = certificateId;
            
            // Show modal
            document.getElementById('certificateModal').classList.remove('hidden');
        }
        
        function closeCertificateModal() {
            document.getElementById('certificateModal').classList.add('hidden');
        }
        
        // Enhanced PDF download function for landscape
        async function downloadCertificateAsPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const certificate = document.getElementById('certificatePreview');
                
                // Temporarily scale up for better quality
                certificate.style.transform = 'scale(1)';
                
                // Use html2canvas to capture the certificate
                const canvas = await html2canvas(certificate, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    width: 1123, // A4 landscape width in pixels at 96 DPI
                    height: 794   // A4 landscape height in pixels at 96 DPI
                });
                
                // Create PDF in landscape orientation
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });
                
                const imgData = canvas.toDataURL('image/png');
                pdf.addImage(imgData, 'PNG', 0, 0, 297, 210); // A4 landscape dimensions in mm
                
                // Generate filename
                const subjectName = document.getElementById('subjectName').textContent;
                const studentName = document.getElementById('studentName').textContent;
                const certificateId = document.getElementById('certificateId').textContent;
                const filename = `Certificate_${studentName}_${subjectName}_${certificateId}.pdf`.replace(/[^a-zA-Z0-9_-]/g, '_');
                
                // Download PDF
                pdf.save(filename);
                
                // Reset scale
                certificate.style.transform = 'scale(0.5)';
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF. Please try again or use the print option.');
            }
        }
        
        // Print function for landscape
        function printCertificate() {
            const printWindow = window.open('', '', 'height=794,width=1123');
            const certificateHTML = document.getElementById('certificatePreview').outerHTML;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Certificate of Completion</title>
                    <style>
                        @page {
                            size: A4 landscape;
                            margin: 0;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: 'Times New Roman', serif;
                        }
                        .certificate-container {
                            width: 297mm;
                            height: 210mm;
                            background: linear-gradient(135deg, #ffffff 0%, #fefefe 50%, #ffffff 100%);
                            position: relative;
                            overflow: hidden;
                            transform: scale(1) !important;
                        }
                        .certificate-border {
                            border: 12px solid #1f2937;
                            border-radius: 8px;
                            margin: 15px;
                            height: calc(100% - 30px);
                            position: relative;
                            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
                        }
                        .certificate-inner-border {
                            border: 3px solid #d4af37;
                            border-radius: 4px;
                            margin: 12px;
                            height: calc(100% - 24px);
                            position: relative;
                            background: #ffffff;
                        }
                        .certificate-header {
                            text-align: center;
                            padding: 25px 0 15px 0;
                            border-bottom: 2px solid #d4af37;
                            margin: 0 50px;
                        }
                        .certificate-logo {
                            font-size: 36px;
                            font-weight: 900;
                            color: #1f2937;
                            margin-bottom: 8px;
                            letter-spacing: 4px;
                            font-family: 'Times New Roman', serif;
                        }
                        .certificate-subtitle {
                            color: #4b5563;
                            font-size: 12px;
                            font-weight: 600;
                            letter-spacing: 3px;
                            text-transform: uppercase;
                            font-family: 'Arial', sans-serif;
                        }
                        .certificate-institution {
                            color: #6b7280;
                            font-size: 10px;
                            font-weight: 500;
                            letter-spacing: 2px;
                            text-transform: uppercase;
                            margin-top: 5px;
                            font-family: 'Arial', sans-serif;
                        }
                        .certificate-title {
                            font-size: 28px;
                            font-weight: bold;
                            color: #1f2937;
                            margin: 25px 0 20px 0;
                            letter-spacing: 2px;
                            text-transform: uppercase;
                            font-family: 'Times New Roman', serif;
                        }
                        .certificate-body {
                            text-align: center;
                            padding: 0 80px;
                            line-height: 1.6;
                            font-family: 'Times New Roman', serif;
                        }
                        .certificate-text {
                            font-size: 14px;
                            color: #374151;
                            margin-bottom: 15px;
                            font-weight: 400;
                        }
                        .certificate-name {
                            font-size: 32px;
                            font-weight: bold;
                            color: #1f2937;
                            margin: 20px 0;
                            border-bottom: 2px solid #d4af37;
                            display: inline-block;
                            padding-bottom: 5px;
                            font-family: 'Times New Roman', serif;
                        }
                        .certificate-subject {
                            font-size: 20px;
                            font-weight: bold;
                            color: #1f2937;
                            margin: 20px 0;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                            font-family: 'Times New Roman', serif;
                        }
                        .certificate-achievement {
                            font-size: 13px;
                            color: #374151;
                            margin: 15px 0;
                            font-style: italic;
                        }
                        .certificate-footer {
                            position: absolute;
                            bottom: 30px;
                            left: 0;
                            right: 0;
                            padding: 0 50px;
                        }
                        .certificate-signatures {
                            display: flex;
                            justify-content: space-between;
                            align-items: end;
                            margin-top: 40px;
                        }
                        .signature-section {
                            text-align: center;
                            position: relative;
                            width: 180px;
                        }
                        .signature-line {
                            width: 180px;
                            border-top: 1px solid #374151;
                            margin-bottom: 8px;
                        }
                        .signature-label {
                            font-size: 11px;
                            color: #4b5563;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                            font-family: 'Arial', sans-serif;
                        }
                        .signature-title {
                            font-size: 10px;
                            color: #6b7280;
                            margin-top: 3px;
                            font-family: 'Arial', sans-serif;
                        }
                        .certificate-seal {
                            position: absolute;
                            top: 40%;
                            right: 50px;
                            transform: translateY(-50%);
                            width: 100px;
                            height: 100px;
                            border: 3px solid #d4af37;
                            border-radius: 50%;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            background: radial-gradient(circle, #fef3c7 0%, #f59e0b 100%);
                        }
                        .seal-text {
                            font-size: 8px;
                            font-weight: bold;
                            color: #92400e;
                            text-align: center;
                            line-height: 1.1;
                            font-family: 'Arial', sans-serif;
                        }
                        .certificate-date-section {
                            position: absolute;
                            bottom: 30px;
                            right: 50px;
                            text-align: center;
                            font-family: 'Times New Roman', serif;
                        }
                        .certificate-date {
                            font-size: 11px;
                            color: #374151;
                            font-weight: 500;
                        }
                        .certificate-decorations {
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            pointer-events: none;
                            overflow: hidden;
                        }
                        .decoration-corner {
                            position: absolute;
                            width: 60px;
                            height: 60px;
                            background: linear-gradient(45deg, rgba(212, 175, 55, 0.1) 0%, transparent 70%);
                        }
                        .decoration-corner.top-left {
                            top: 0;
                            left: 0;
                            border-radius: 0 0 60px 0;
                        }
                        .decoration-corner.top-right {
                            top: 0;
                            right: 0;
                            border-radius: 0 0 0 60px;
                        }
                        .decoration-corner.bottom-left {
                            bottom: 0;
                            left: 0;
                            border-radius: 0 60px 0 0;
                        }
                        .decoration-corner.bottom-right {
                            bottom: 0;
                            right: 0;
                            border-radius: 60px 0 0 0;
                        }
                    </style>
                </head>
                <body>
                    ${certificateHTML}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }
        
        // Enrollment functions for students
        function unenrollFromSubject(subjectId, subjectName) {
            if (confirm(`Are you sure you want to unenroll from "${subjectName}"?`)) {
                fetch(`/subject/${subjectId}/unenroll`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload(); // Refresh to show updated enrollment status
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('An error occurred while unenrolling.');
                });
            }
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Setup search for teachers
            setupSearch('subject-search', 'subjects-container', '.subject-card', ['subjectName', 'subjectDescription']);
            setupSearch('quiz-search', 'quizzes-container', '.quiz-card', ['quizTitle', 'subject']);
            setupSubjectFilter('subject-filter', 'quizzes-container');
            
            // Setup search for students
            setupSearch('enrolled-subject-search', 'enrolled-subjects-container', '.subject-card', ['subjectName', 'subjectDescription', 'teacherName']);
            setupSearch('student-quiz-search', 'student-quizzes-container', '.quiz-card', ['quizTitle', 'subject']);
            setupSubjectFilter('student-subject-filter', 'student-quizzes-container');
            
            // Certificate download buttons
            document.querySelectorAll('.download-certificate-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const subjectId = this.dataset.subjectId;
                    const subjectName = this.dataset.subjectName;
                    generateCertificate(subjectId, subjectName);
                });
            });
            
            // Quiz take buttons
            document.querySelectorAll('.quiz-take-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const quizId = this.dataset.quizId;
                    window.location.href = `/quiz/${quizId}/take`;
                });
            });
            
            // Quiz results buttons
            document.querySelectorAll('.quiz-results-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const quizId = this.dataset.quizId;
                    window.location.href = `/quiz/${quizId}/results`;
                });
            });
            
            // Quiz preview buttons (for teachers)
            document.querySelectorAll('.quiz-preview-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const quizId = this.dataset.quizId;
                    window.location.href = `/quiz/${quizId}/preview`;
                });
            });
        });
    </script>
{% endblock %}
{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
{% endblock %}

{% block footer %}
    <div class="text-center">
        <p>&copy; 2024 Quizera. All rights reserved.</p>
        <p class="text-gray-400 text-sm mt-2">E-Learning Platform for Computer Science Students</p>
    </div>
{% endblock %}