{% extends "base.html" %}

{% block title %}Notifications{% endblock %}
{% block head %}
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto px-4 py-6">
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-2xl font-semibold">Notifications</h1>
    <div class="flex items-center gap-2">
      <span class="text-sm text-gray-600">Unread: {{ unread_count }}</span>
      <button id="markAllBtn"
              class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded"
              {% if unread_count == 0 %}disabled class="opacity-50 cursor-not-allowed"{% endif %}>
        Mark all as read
      </button>
      <button id="deleteAllBtn"
              class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded"
              {% if not notifications %}disabled class="opacity-50 cursor-not-allowed"{% endif %}>
        Delete all
      </button>
    </div>
  </div>

  {% if notifications %}
    <ul class="space-y-3">
      {% for n in notifications %}
        <li class="border rounded p-4 {% if not n.read %}bg-blue-50 border-blue-200{% else %}bg-white{% endif %}" data-notification-id="{{ n.id }}">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="flex items-center gap-2">
                <span class="text-sm px-2 py-0.5 rounded bg-gray-100 text-gray-700">{{ n.type|default('info') }}</span>
                {% if n.icon %}
                  <span class="text-gray-500 text-sm">[{{ n.icon }}]</span>
                {% endif %}
              </div>
              <h3 class="font-medium mt-1">{{ n.title }}</h3>
              <p class="text-gray-700 mt-1">{{ n.message }}</p>
              <div class="text-gray-500 text-sm mt-2">
                {{ n.created_at }}
                {% if n.actor_name %} â€¢ by {{ n.actor_name }}{% endif %}
              </div>

              {% if n.link_url %}
                <a class="inline-block mt-2 text-blue-600 hover:text-blue-800 underline"
                   href="{{ n.link_url }}">
                  View
                </a>
              {% endif %}
            </div>
            <div class="ml-4 flex flex-col gap-2">
              {% if not n.read %}
                <button class="markReadBtn text-sm text-blue-600 hover:text-blue-800 underline"
                        data-id="{{ n.id }}">
                  Mark as read
                </button>
              {% else %}
                <span class="text-sm text-gray-400">Read</span>
              {% endif %}
              <button class="deleteBtn text-sm text-red-600 hover:text-red-800 underline"
                      data-id="{{ n.id }}"
                      title="Delete notification">
                Delete
              </button>
            </div>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div class="text-gray-600">No notifications.</div>
  {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 max-w-sm mx-4">
    <h3 class="text-lg font-medium mb-4">Confirm Delete</h3>
    <p class="text-gray-600 mb-6">Are you sure you want to delete this notification? This action cannot be undone.</p>
    <div class="flex justify-end gap-3">
      <button id="cancelDelete" class="px-4 py-2 text-gray-600 hover:text-gray-800">
        Cancel
      </button>
      <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
        Delete
      </button>
    </div>
  </div>
</div>

<!-- Delete All Confirmation Modal -->
<div id="deleteAllModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 max-w-sm mx-4">
    <h3 class="text-lg font-medium mb-4">Delete All Notifications</h3>
    <p class="text-gray-600 mb-6">Are you sure you want to delete all notifications? This action cannot be undone.</p>
    <div class="flex justify-end gap-3">
      <button id="cancelDeleteAll" class="px-4 py-2 text-gray-600 hover:text-gray-800">
        Cancel
      </button>
      <button id="confirmDeleteAll" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
        Delete All
      </button>
    </div>
  </div>
</div>

<script>
  let notificationToDelete = null;

  // Mark all as read
  document.getElementById('markAllBtn')?.addEventListener('click', async () => {
    const res = await fetch('/notifications/mark-all-read', { method: 'POST' });
    if (res.ok) location.reload();
  });

  // Mark single notification as read
  document.querySelectorAll('.markReadBtn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id;
      const res = await fetch(`/notifications/${id}/read`, { method: 'POST' });
      if (res.ok) location.reload();
    });
  });

  // Delete single notification
  document.querySelectorAll('.deleteBtn').forEach(btn => {
    btn.addEventListener('click', () => {
      notificationToDelete = btn.dataset.id;
      showModal('deleteModal');
    });
  });

  // Delete all notifications
  document.getElementById('deleteAllBtn')?.addEventListener('click', () => {
    showModal('deleteAllModal');
  });

  // Modal controls
  function showModal(modalId) {
    document.getElementById(modalId).classList.remove('hidden');
    document.getElementById(modalId).classList.add('flex');
  }

  function hideModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
    document.getElementById(modalId).classList.remove('flex');
  }

  // Single delete confirmation
  document.getElementById('confirmDelete').addEventListener('click', async () => {
    if (notificationToDelete) {
      const res = await fetch(`/notifications/${notificationToDelete}`, { 
        method: 'DELETE' 
      });
      
      if (res.ok) {
        // Remove the notification from the DOM
        const notificationElement = document.querySelector(`[data-notification-id="${notificationToDelete}"]`);
        if (notificationElement) {
          notificationElement.remove();
        }
        
        // Check if there are any notifications left
        const remainingNotifications = document.querySelectorAll('[data-notification-id]');
        if (remainingNotifications.length === 0) {
          location.reload(); // Reload to show "No notifications" message
        }
      } else {
        alert('Failed to delete notification');
      }
    }
    
    hideModal('deleteModal');
    notificationToDelete = null;
  });

  document.getElementById('cancelDelete').addEventListener('click', () => {
    hideModal('deleteModal');
    notificationToDelete = null;
  });

  // Delete all confirmation
  document.getElementById('confirmDeleteAll').addEventListener('click', async () => {
    const res = await fetch('/notifications/delete-all', { 
      method: 'DELETE' 
    });
    
    if (res.ok) {
      location.reload();
    } else {
      alert('Failed to delete notifications');
    }
    
    hideModal('deleteAllModal');
  });

  document.getElementById('cancelDeleteAll').addEventListener('click', () => {
    hideModal('deleteAllModal');
  });

  // Close modal when clicking outside
  document.getElementById('deleteModal').addEventListener('click', (e) => {
    if (e.target.id === 'deleteModal') {
      hideModal('deleteModal');
      notificationToDelete = null;
    }
  });

  document.getElementById('deleteAllModal').addEventListener('click', (e) => {
    if (e.target.id === 'deleteAllModal') {
      hideModal('deleteAllModal');
    }
  });
</script>
{% endblock %}