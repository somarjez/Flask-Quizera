{% extends "base.html" %}

{% block title %}Edit Topic - {{ topic.title }} - Quizera{% endblock %}

{% block extra_head %}
<style>
    .form-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: calc(100vh - 80px);
    }
    
    .content-editor {
        min-height: 300px;
        resize: vertical;
    }
    
    .video-preview {
        max-width: 560px;
        max-height: 315px;
        width: 100%;
        height: auto;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .char-counter {
        font-size: 0.875rem;
        color: #6b7280;
    }
    
    .char-counter.warning {
        color: #f59e0b;
    }
    
    .char-counter.danger {
        color: #ef4444;
    }
</style>
{% endblock %}

{% block main_class %}{% endblock %}

{% block content %}
<div class="form-container py-8">
    <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-white mb-4">
                    <i class="fas fa-edit mr-3"></i>Edit Topic
                </h1>
                <p class="text-white text-lg opacity-90">
                    Update your topic content and make it engaging for students
                </p>
            </div>

            <!-- Breadcrumb Navigation -->
            <div class="mb-6">
                <nav class="flex" aria-label="Breadcrumb">
                    <ol class="inline-flex items-center space-x-1 md:space-x-3">
                        <li class="inline-flex items-center">
                            <a href="{{ url_for('dashboard') }}" class="text-white hover:text-blue-200 transition-colors">
                                <i class="fas fa-home mr-2"></i>Dashboard
                            </a>
                        </li>
                        <li>
                            <div class="flex items-center">
                                <i class="fas fa-chevron-right text-white mx-2"></i>
                                <a href="{{ url_for('view_subject', subject_id=topic.subject_id) }}" class="text-white hover:text-blue-200 transition-colors">
                                    Subject
                                </a>
                            </div>
                        </li>
                        <li>
                            <div class="flex items-center">
                                <i class="fas fa-chevron-right text-white mx-2"></i>
                                <a href="{{ url_for('view_topic', topic_id=topic.id) }}" class="text-white hover:text-blue-200 transition-colors">
                                    {{ topic.title[:30] }}{% if topic.title|length > 30 %}...{% endif %}
                                </a>
                            </div>
                        </li>
                        <li aria-current="page">
                            <div class="flex items-center">
                                <i class="fas fa-chevron-right text-white mx-2"></i>
                                <span class="text-blue-200">Edit</span>
                            </div>
                        </li>
                    </ol>
                </nav>
            </div>

            <!-- Edit Form -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 transition-colors duration-300">
                <form method="POST" id="editTopicForm" class="space-y-6">
                    <!-- Topic Title -->
                    <div class="form-group">
                        <label for="title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-heading mr-2 text-blue-600"></i>Topic Title *
                        </label>
                        <input type="text" 
                               id="title" 
                               name="title" 
                               value="{{ topic.title }}"
                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 transition-colors duration-300" 
                               placeholder="Enter an engaging topic title..."
                               maxlength="200"
                               required>
                        <div class="flex justify-between mt-1">
                            <span class="text-sm text-gray-500 dark:text-gray-400">
                                Choose a clear, descriptive title for your topic
                            </span>
                            <span id="titleCounter" class="char-counter">
                                {{ topic.title|length }}/200
                            </span>
                        </div>
                    </div>

                    <!-- Content Text -->
                    <div class="form-group">
                        <label for="content_text" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-align-left mr-2 text-green-600"></i>Topic Content
                        </label>
                        <textarea id="content_text" 
                                  name="content_text" 
                                  class="content-editor w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 transition-colors duration-300" 
                                  placeholder="Write your topic content here... You can include explanations, examples, code snippets, and detailed information about the topic."
                                  maxlength="10000">{{ topic.content_text }}</textarea>
                        <div class="flex justify-between mt-1">
                            <span class="text-sm text-gray-500 dark:text-gray-400">
                                <i class="fas fa-info-circle mr-1"></i>
                                Use detailed explanations, examples, and formatting to make content engaging
                            </span>
                            <span id="contentCounter" class="char-counter">
                                {{ topic.content_text|length }}/10000
                            </span>
                        </div>
                        
                        <!-- Content Tips -->
                        <div class="mt-3 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                            <h4 class="text-sm font-medium text-blue-800 dark:text-blue-200 mb-2">
                                <i class="fas fa-lightbulb mr-1"></i>Content Writing Tips:
                            </h4>
                            <ul class="text-sm text-blue-700 dark:text-blue-300 space-y-1">
                                <li>• Start with an overview or introduction</li>
                                <li>• Use clear headings and subheadings</li>
                                <li>• Include practical examples and code snippets</li>
                                <li>• Break down complex concepts into simple steps</li>
                                <li>• Add references to additional resources when helpful</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Video Link -->
                    <div class="form-group">
                        <label for="video_link" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-video mr-2 text-red-600"></i>Video Link (Optional)
                        </label>
                        <input type="url" 
                               id="video_link" 
                               name="video_link" 
                               value="{{ topic.video_link or '' }}"
                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 transition-colors duration-300" 
                               placeholder="https://www.youtube.com/watch?v=... or https://vimeo.com/...">
                        <div class="mt-1">
                            <span class="text-sm text-gray-500 dark:text-gray-400">
                                <i class="fas fa-info-circle mr-1"></i>
                                Add YouTube, Vimeo, or other educational video links to enhance learning
                            </span>
                        </div>
                        
                        <!-- Video Preview -->
                        <div id="videoPreview" class="mt-4 hidden">
                            <div class="p-4 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg">
                                <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    <i class="fas fa-eye mr-1"></i>Video Preview:
                                </h4>
                                <div id="videoEmbed" class="aspect-video bg-gray-200 dark:bg-gray-600 rounded flex items-center justify-center">
                                    <span class="text-gray-500 dark:text-gray-400">Video will appear here</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200 dark:border-gray-600">
                        <!-- Save Button -->
                        <button type="submit" 
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                            <i class="fas fa-save mr-2"></i>
                            Update Topic
                        </button>
                        
                        <!-- Preview Button -->
                        <button type="button" 
                                id="previewBtn"
                                class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                            <i class="fas fa-eye mr-2"></i>
                            Preview Changes
                        </button>
                        
                        <!-- Cancel Button -->
                        <a href="{{ url_for('view_topic', topic_id=topic.id) }}" 
                           class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-[1.02] text-center">
                            <i class="fas fa-times mr-2"></i>
                            Cancel
                        </a>
                        
                        <!-- Delete Button (with confirmation) -->
                        <button type="button" 
                                id="deleteBtn"
                                class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                            <i class="fas fa-trash mr-2"></i>
                            Delete
                        </button>
                    </div>
                </form>
            </div>

            <!-- Save Status Indicator -->
            <div id="saveStatus" class="hidden fixed bottom-4 right-4 z-50">
                <div class="bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg">
                    <i class="fas fa-check-circle mr-2"></i>
                    Changes saved successfully!
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200 dark:border-gray-600">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">
                    <i class="fas fa-eye mr-2 text-blue-600"></i>Topic Preview
                </h3>
                <button id="closePreview" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        <div class="p-6">
            <div id="previewContent">
                <!-- Preview content will be inserted here -->
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full">
        <div class="p-6">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/20 mb-4">
                    <i class="fas fa-exclamation-triangle text-red-600 dark:text-red-400 text-xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">Delete Topic</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">
                    Are you sure you want to delete this topic? This action cannot be undone and will remove all content associated with this topic.
                </p>
                <div class="flex gap-3">
                    <button id="confirmDelete" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                        <i class="fas fa-trash mr-2"></i>Delete
                    </button>
                    <button id="cancelDelete" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form elements
    const form = document.getElementById('editTopicForm');
    const titleInput = document.getElementById('title');
    const contentInput = document.getElementById('content_text');
    const videoInput = document.getElementById('video_link');
    const previewBtn = document.getElementById('previewBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    
    // Modal elements
    const previewModal = document.getElementById('previewModal');
    const deleteModal = document.getElementById('deleteModal');
    const closePreview = document.getElementById('closePreview');
    const confirmDelete = document.getElementById('confirmDelete');
    const cancelDelete = document.getElementById('cancelDelete');
    
    // Character counters
    const titleCounter = document.getElementById('titleCounter');
    const contentCounter = document.getElementById('contentCounter');
    
    // Character count updating
    function updateCharCount(input, counter, maxLength) {
        const currentLength = input.value.length;
        counter.textContent = `${currentLength}/${maxLength}`;
        
        // Add warning colors
        counter.className = 'char-counter';
        if (currentLength > maxLength * 0.9) {
            counter.classList.add('danger');
        } else if (currentLength > maxLength * 0.75) {
            counter.classList.add('warning');
        }
    }
    
    titleInput.addEventListener('input', () => updateCharCount(titleInput, titleCounter, 200));
    contentInput.addEventListener('input', () => updateCharCount(contentInput, contentCounter, 10000));
    
    // Video preview functionality
    function updateVideoPreview() {
        const videoUrl = videoInput.value.trim();
        const videoPreview = document.getElementById('videoPreview');
        const videoEmbed = document.getElementById('videoEmbed');
        
        if (!videoUrl) {
            videoPreview.classList.add('hidden');
            return;
        }
        
        let embedUrl = '';
        
        // YouTube URL handling
        if (videoUrl.includes('youtube.com/watch') || videoUrl.includes('youtu.be/')) {
            const videoId = extractYouTubeId(videoUrl);
            if (videoId) {
                embedUrl = `https://www.youtube.com/embed/${videoId}`;
            }
        }
        // Vimeo URL handling
        else if (videoUrl.includes('vimeo.com/')) {
            const videoId = extractVimeoId(videoUrl);
            if (videoId) {
                embedUrl = `https://player.vimeo.com/video/${videoId}`;
            }
        }
        
        if (embedUrl) {
            videoEmbed.innerHTML = `<iframe src="${embedUrl}" class="video-preview rounded" frameborder="0" allowfullscreen></iframe>`;
            videoPreview.classList.remove('hidden');
        } else {
            videoEmbed.innerHTML = '<span class="text-gray-500 dark:text-gray-400">Invalid video URL format</span>';
            videoPreview.classList.remove('hidden');
        }
    }
    
    function extractYouTubeId(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }
    
    function extractVimeoId(url) {
        const regExp = /(?:vimeo)\.com.*(?:videos|video|channels|)\/([\d]+)/i;
        const match = url.match(regExp);
        return match ? match[1] : null;
    }
    
    videoInput.addEventListener('input', updateVideoPreview);
    videoInput.addEventListener('blur', updateVideoPreview);
    
    // Initialize video preview if URL exists
    if (videoInput.value) {
        updateVideoPreview();
    }
    
    // Preview functionality
    previewBtn.addEventListener('click', function() {
        const title = titleInput.value.trim();
        const content = contentInput.value.trim();
        const videoUrl = videoInput.value.trim();
        
        let previewHTML = `
            <div class="space-y-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-4">${title || 'Untitled Topic'}</h1>
                    ${content ? `
                        <div class="prose dark:prose-invert max-w-none">
                            <div class="whitespace-pre-wrap text-gray-700 dark:text-gray-300">${content}</div>
                        </div>
                    ` : '<p class="text-gray-500 dark:text-gray-400 italic">No content added yet.</p>'}
                </div>
        `;
        
        if (videoUrl) {
            let embedUrl = '';
            if (videoUrl.includes('youtube.com/watch') || videoUrl.includes('youtu.be/')) {
                const videoId = extractYouTubeId(videoUrl);
                if (videoId) embedUrl = `https://www.youtube.com/embed/${videoId}`;
            } else if (videoUrl.includes('vimeo.com/')) {
                const videoId = extractVimeoId(videoUrl);
                if (videoId) embedUrl = `https://player.vimeo.com/video/${videoId}`;
            }
            
            if (embedUrl) {
                previewHTML += `
                    <div class="mt-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">
                            <i class="fas fa-video mr-2 text-red-600"></i>Video Content
                        </h3>
                        <div class="aspect-video">
                            <iframe src="${embedUrl}" class="w-full h-full rounded-lg" frameborder="0" allowfullscreen></iframe>
                        </div>
                    </div>
                `;
            }
        }
        
        previewHTML += '</div>';
        
        document.getElementById('previewContent').innerHTML = previewHTML;
        previewModal.classList.remove('hidden');
    });
    
    // Close preview modal
    closePreview.addEventListener('click', function() {
        previewModal.classList.add('hidden');
    });
    
    // Close modal when clicking outside
    previewModal.addEventListener('click', function(e) {
        if (e.target === previewModal) {
            previewModal.classList.add('hidden');
        }
    });
    
    // Delete functionality
    deleteBtn.addEventListener('click', function() {
        deleteModal.classList.remove('hidden');
    });
    
    cancelDelete.addEventListener('click', function() {
        deleteModal.classList.add('hidden');
    });
    
    confirmDelete.addEventListener('click', function() {
        // Show loading state
        confirmDelete.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Deleting...';
        confirmDelete.disabled = true;
        
        // Send delete request
        fetch(`/topic/{{ topic.id }}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message and redirect
                showMessage('Topic deleted successfully!', 'success');
                setTimeout(() => {
                    window.location.href = "{{ url_for('view_subject', subject_id=topic.subject_id) }}";
                }, 1500);
            } else {
                showMessage(data.message || 'Error deleting topic', 'error');
                confirmDelete.innerHTML = '<i class="fas fa-trash mr-2"></i>Delete';
                confirmDelete.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Error deleting topic', 'error');
            confirmDelete.innerHTML = '<i class="fas fa-trash mr-2"></i>Delete';
            confirmDelete.disabled = false;
        });
    });
    
    // Close delete modal when clicking outside
    deleteModal.addEventListener('click', function(e) {
        if (e.target === deleteModal) {
            deleteModal.classList.add('hidden');
        }
    });
    
    // Form submission handling
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        // Show loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Updating...';
        submitBtn.disabled = true;
        
        // Validate form
        const title = titleInput.value.trim();
        if (!title) {
            showMessage('Topic title is required', 'error');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            titleInput.focus();
            return;
        }
        
        // Submit form
        fetch(window.location.href, {
            method: 'POST',
            body: new FormData(form)
        })
        .then(response => {
            if (response.ok) {
                showMessage('Topic updated successfully!', 'success');
                
                // Show save status
                const saveStatus = document.getElementById('saveStatus');
                saveStatus.classList.remove('hidden');
                setTimeout(() => {
                    saveStatus.classList.add('hidden');
                }, 3000);
                
                // Redirect to topic view
                setTimeout(() => {
                    window.location.href = "{{ url_for('view_topic', topic_id=topic.id) }}";
                }, 1500);
            } else {
                return response.text().then(text => {
                    throw new Error('Server error: ' + response.status);
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Error updating topic. Please try again.', 'error');
        })
        .finally(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });
    
    // Auto-save functionality (optional)
    let autoSaveTimeout;
    function setupAutoSave() {
        [titleInput, contentInput, videoInput].forEach(input => {
            input.addEventListener('input', function() {
                clearTimeout(autoSaveTimeout);
                autoSaveTimeout = setTimeout(() => {
                    // Auto-save to localStorage
                    localStorage.setItem('edit_topic_{{ topic.id }}', JSON.stringify({
                        title: titleInput.value,
                        content: contentInput.value,
                        video: videoInput.value,
                        timestamp: Date.now()
                    }));
                }, 2000);
            });
        });
    }
    
    // Load from localStorage if available
    function loadAutoSave() {
        const saved = localStorage.getItem('edit_topic_{{ topic.id }}');
        if (saved) {
            try {
                const data = JSON.parse(saved);
                // Only load if saved within last hour
                if (Date.now() - data.timestamp < 3600000) {
                    if (data.title !== titleInput.value || 
                        data.content !== contentInput.value || 
                        data.video !== videoInput.value) {
                        
                        if (confirm('Found unsaved changes. Would you like to restore them?')) {
                            titleInput.value = data.title;
                            contentInput.value = data.content;
                            videoInput.value = data.video;
                            
                            // Update counters
                            updateCharCount(titleInput, titleCounter, 200);
                            updateCharCount(contentInput, contentCounter, 10000);
                            updateVideoPreview();
                        }
                    }
                }
            } catch (e) {
                console.warn('Could not load auto-saved data:', e);
            }
        }
    }
    
    setupAutoSave();
    loadAutoSave();
    
    // Clear auto-save on successful submit
    form.addEventListener('submit', function() {
        localStorage.removeItem('edit_topic_{{ topic.id }}');
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + S to save
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            form.dispatchEvent(new Event('submit'));
        }
        
        // Escape to close modals
        if (e.key === 'Escape') {
            if (!previewModal.classList.contains('hidden')) {
                previewModal.classList.add('hidden');
            }
            if (!deleteModal.classList.contains('hidden')) {
                deleteModal.classList.add('hidden');
            }
        }
    });
});
</script>
{% endblock %}