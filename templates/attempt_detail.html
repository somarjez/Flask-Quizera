{% extends "base.html" %}

{% block title %}Quiz Attempt Details - Quizera{% endblock %}

{% block extra_head %}
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/attemptdetail.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Breadcrumb Navigation -->
    <nav class="flex mb-6" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="{{ url_for('dashboard') }}" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600">
                    <i class="fas fa-home mr-2"></i>Dashboard
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mr-2"></i>
                    <a href="{{ url_for('quiz_results', quiz_id=attempt.quiz_id) }}" class="ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2">Quiz Results</a>
                </div>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mr-2"></i>
                    <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2">Attempt Details</span>
                </div>
            </li>
        </ol>
    </nav>

    <!-- Attempt Header -->
    <div class="bg-white rounded-lg shadow-md p-8 mb-8">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-3xl font-bold gradient-text mb-2">{{ attempt.quiz_title }}</h1>
                {% if quiz %}
                    <p class="text-gray-600 mb-4">{{ quiz.description }}</p>
                {% endif %}
                <div class="flex items-center space-x-6 text-sm text-gray-500">
                    <span><i class="fas fa-calendar mr-1"></i>{{ attempt.submitted_at.strftime('%B %d, %Y at %I:%M %p') }}</span>
                    <span><i class="fas fa-user mr-1"></i>{{ attempt.username }}</span>
                    {% if quiz %}
                        <span><i class="fas fa-book mr-1"></i>{{ quiz.subject_name }}</span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Score Display -->
            <div class="text-center">
                <div class="text-4xl font-bold mb-2
                    {% if attempt.percentage >= 90 %}text-green-600
                    {% elif attempt.percentage >= 75 %}text-blue-600
                    {% elif attempt.percentage >= 60 %}text-yellow-600
                    {% else %}text-red-600
                    {% endif %}">
                    {{ "%.1f"|format(attempt.percentage) }}%
                </div>
                <p class="text-sm text-gray-500">{{ attempt.earned_points }}/{{ attempt.total_points }} points</p>
                <p class="text-xs text-gray-400 mt-1">
                    {% if attempt.percentage >= 90 %}Excellent
                    {% elif attempt.percentage >= 75 %}Good
                    {% elif attempt.percentage >= 60 %}Fair
                    {% else %}Needs Improvement
                    {% endif %}
                </p>
            </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="w-full bg-gray-200 rounded-full h-4 mb-2">
            <div class="h-4 rounded-full transition-all duration-500
                {% if attempt.percentage >= 90 %}bg-green-600
                {% elif attempt.percentage >= 75 %}bg-blue-600
                {% elif attempt.percentage >= 60 %}bg-yellow-600
                {% else %}bg-red-600
                {% endif %}"
                style="width: {{ attempt.percentage }}%"></div>
        </div>
        <p class="text-sm text-gray-600">Overall Performance</p>
    </div>

    <!-- Question Review -->
    <div class="space-y-6">
        {% for question in questions %}
            {% set question_result = attempt.results.get(question.id, {}) %}
            {% set is_correct = question_result.get('is_correct', False) %}
            
            <div class="bg-white rounded-lg shadow-md p-8 {{ 'question-correct' if is_correct else 'question-incorrect' }} card-hover">
                <!-- Question Header -->
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">
                        Question {{ loop.index }}
                        <span class="text-sm font-normal text-gray-600">({{ question.points }} point{{ 's' if question.points != 1 }})</span>
                    </h3>
                    <div class="flex items-center space-x-2">
                        {% if is_correct %}
                            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
                                <i class="fas fa-check mr-1"></i>Correct
                            </span>
                        {% else %}
                            <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium">
                                <i class="fas fa-times mr-1"></i>Incorrect
                            </span>
                        {% endif %}
                        <span class="text-sm text-gray-500">+{{ question.points if is_correct else 0 }} pts</span>
                    </div>
                </div>
                
                <!-- Question Text -->
                <div class="mb-6">
                    <p class="text-lg text-gray-800 mb-4">{{ question.question_text }}</p>
                </div>
                
                <!-- Answers Section -->
                <div class="space-y-4">
                    {% if question.question_type == 'multiple_choice' %}
                        <div class="grid grid-cols-1 gap-3">
                            {% for option in question.options %}
                                {% if option %}
                                    {% set option_letter = ['A', 'B', 'C', 'D'][loop.index0] %}
                                    {% set is_user_answer = question_result.get('user_answer') == option_letter %}
                                    {% set is_correct_answer = question.correct_answer == option_letter %}
                                    
                                    <div class="p-3 rounded-lg border 
                                        {% if is_correct_answer %}answer-correct
                                        {% elif is_user_answer %}answer-incorrect
                                        {% else %}border-gray-200 bg-gray-50
                                        {% endif %}">
                                        <div class="flex items-center justify-between">
                                            <span class="font-medium">{{ option_letter }}. {{ option }}</span>
                                            <div class="flex items-center space-x-2">
                                                {% if is_correct_answer %}
                                                    <span class="text-green-600 text-sm">
                                                        <i class="fas fa-check"></i> Correct Answer
                                                    </span>
                                                {% endif %}
                                                {% if is_user_answer and not is_correct_answer %}
                                                    <span class="text-red-600 text-sm">
                                                        <i class="fas fa-times"></i> Your Answer
                                                    </span>
                                                {% elif is_user_answer and is_correct_answer %}
                                                    <span class="text-green-600 text-sm">
                                                        <i class="fas fa-check"></i> Your Answer
                                                    </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        
                    {% elif question.question_type == 'true_false' %}
                        <div class="grid grid-cols-2 gap-4">
                            {% for option in ['True', 'False'] %}
                                {% set option_value = option.lower() %}
                                {% set is_user_answer = question_result.get('user_answer') == option_value or (question_result.get('user_answer') == True and option == 'True') or (question_result.get('user_answer') == False and option == 'False') %}
                                {% set is_correct_answer = (question.correct_answer == True and option == 'True') or (question.correct_answer == False and option == 'False') %}
                                
                                <div class="p-4 rounded-lg border text-center
                                    {% if is_correct_answer %}answer-correct
                                    {% elif is_user_answer %}answer-incorrect
                                    {% else %}border-gray-200 bg-gray-50
                                    {% endif %}">
                                    <div class="font-medium text-lg mb-2">{{ option }}</div>
                                    <div class="text-sm">
                                        {% if is_correct_answer %}
                                            <span class="text-green-600">
                                                <i class="fas fa-check"></i> Correct
                                            </span>
                                        {% endif %}
                                        {% if is_user_answer and not is_correct_answer %}
                                            <span class="text-red-600">
                                                <i class="fas fa-times"></i> Your Choice
                                            </span>
                                        {% elif is_user_answer and is_correct_answer %}
                                            <span class="text-green-600">
                                                <i class="fas fa-check"></i> Your Choice
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        
                    {% elif question.question_type in ['identification', 'enumeration'] %}
                        <div class="space-y-3">
                            <!-- User's Answer -->
                            <div class="p-4 rounded-lg {{ 'answer-correct' if is_correct else 'answer-incorrect' }}">
                                <div class="font-medium text-sm mb-2">Your Answer:</div>
                                <div class="text-lg">
                                    {% if question_result.get('user_answer') %}
                                        {% if question_result.user_answer is string %}
                                            {{ question_result.user_answer }}
                                        {% else %}
                                            {{ question_result.user_answer | join(', ') }}
                                        {% endif %}
                                    {% else %}
                                        <em class="text-gray-500">No answer provided</em>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Correct Answer(s) -->
                            <div class="p-4 rounded-lg answer-correct">
                                <div class="font-medium text-sm mb-2">
                                    {% if question.question_type == 'enumeration' %}Possible Correct Answers:
                                    {% else %}Correct Answer:{% endif %}
                                </div>
                                <div class="text-lg">
                                    {% if question.correct_answers %}
                                        {{ question.correct_answers | join(', ') }}
                                    {% else %}
                                        {{ question.correct_answer }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Summary and Actions -->
    <div class="bg-white rounded-lg shadow-md p-8 mt-8 text-center">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Quiz Summary</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="text-2xl font-bold text-blue-600">{{ questions | length }}</div>
                <div class="text-sm text-gray-600">Total Questions</div>
            </div>
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="text-2xl font-bold text-green-600">
                    {{ attempt.results.values() | selectattr('is_correct') | list | length }}
                </div>
                <div class="text-sm text-gray-600">Correct Answers</div>
            </div>
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="text-2xl font-bold text-red-600">
                    {{ questions | length - (attempt.results.values() | selectattr('is_correct') | list | length) }}
                </div>
                <div class="text-sm text-gray-600">Incorrect Answers</div>
            </div>
        </div>
        
        <div class="flex justify-center space-x-4">
            <a href="{{ url_for('take_quiz', quiz_id=attempt.quiz_id) }}" 
                class="bg-green-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors">
                    <i class="fas fa-redo mr-2"></i>Retake Quiz
                </a>

            <a href="{{ url_for('quiz_results', quiz_id=attempt.quiz_id) }}" 
               class="bg-blue-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-600 transition-colors">
                <i class="fas fa-chart-line mr-2"></i>View All Results
            </a>
            <a href="{{ url_for('dashboard') }}" 
               class="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                <i class="fas fa-home mr-2"></i>Dashboard
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/attemptdetail.js') }}"></script>
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
{% endblock %}